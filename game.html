<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TerNix - In Game</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; user-select: none; }
        
        /* UI CONTAINER */
        #hud { position: absolute; inset: 0; pointer-events: none; }

        /* 2010 STYLE LEADERBOARD */
        #leaderboard {
            position: absolute; top: 20px; right: 20px; width: 180px;
            background: rgba(30, 30, 30, 0.8); color: white;
            border: 1px solid #555;
        }
        .lb-head { background: #0055b3; padding: 5px; font-weight: bold; font-size: 12px; }
        .lb-item { padding: 4px; font-size: 12px; border-bottom: 1px solid #444; display: flex; justify-content: space-between; }

        /* 2010 STYLE CHAT */
        #chat-container {
            position: absolute; top: 20px; left: 20px; width: 350px; height: 250px;
            display: flex; flex-direction: column; pointer-events: auto;
        }
        #chat-history {
            flex: 1; overflow-y: auto; text-shadow: 1px 1px 0 #000; color: white; font-size: 14px;
            margin-bottom: 5px;
        }
        #chat-input {
            background: rgba(0,0,0,0.5); border: 1px solid #fff; color: white; padding: 5px;
            display: none; /* Hidden until / is pressed */
        }

        /* RETRO CURSOR & MESSAGE */
        .system-msg { color: #ffff00; font-style: italic; }
        .user-msg { color: white; }
    </style>
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>
</head>
<body>

    <div id="hud">
        <div id="leaderboard">
            <div class="lb-head">Players</div>
            <div class="lb-item"><span id="p-name">Guest</span><span>100</span></div>
        </div>
        <div id="chat-container">
            <div id="chat-history">
                <div class="system-msg">System: Welcome to TerNix. Press '/' to chat.</div>
            </div>
            <input type="text" id="chat-input">
        </div>
    </div>

    <!-- EXIT BUTTON -->
    <button style="position:absolute; top:0; left:50%; transform:translateX(-50%); z-index:999; cursor:pointer;" onclick="window.location.href='index.html'">LEAVE GAME</button>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // CONFIG
        const USERNAME = localStorage.getItem('ternix_user') || "Guest";
        document.getElementById('p-name').innerText = USERNAME;

        // WORLD & PHYSICS
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xb0d6f5);
        scene.fog = new THREE.Fog(0xb0d6f5, 20, 150);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // LIGHTS
        const ambient = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambient);
        const sun = new THREE.DirectionalLight(0xffffff, 0.8);
        sun.position.set(50, 100, 50);
        scene.add(sun);

        // --- PHYSICS SYSTEM ---
        const worldColliders = []; // Array for walls/floors
        
        function createPart(x, y, z, w, h, d, color) {
            const geo = new THREE.BoxGeometry(w, h, d);
            const mat = new THREE.MeshLambertMaterial({ color: color });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(x, y, z);
            scene.add(mesh);
            
            // Add to physics world
            const box = new THREE.Box3().setFromObject(mesh);
            worldColliders.push(box);
            return mesh;
        }

        // BUILD MAP
        createPart(0, -1, 0, 200, 2, 200, 0x228822); // Baseplate
        createPart(0, 2, 15, 6, 1, 6, 0x555555);
        createPart(0, 4, 25, 6, 1, 6, 0x555555);
        createPart(8, 6, 35, 6, 1, 6, 0x555555); // Parkour
        createPart(0, 10, 50, 20, 1, 20, 0xffda00); // Winner

        // PLAYER SETUP
        const playerGroup = new THREE.Group();
        playerGroup.position.set(0, 5, 0);
        scene.add(playerGroup);

        const cameraPivot = new THREE.Object3D();
        cameraPivot.position.y = 1.5; // Eye level
        playerGroup.add(cameraPivot);

        // LOAD CHARACTER (With Resize)
        const loader = new GLTFLoader();
        loader.load('Ternix.Guy.glb', (gltf) => {
            const model = gltf.scene;
            model.scale.set(0.3, 0.3, 0.3); // SCALED DOWN TO 30%
            model.rotation.y = Math.PI;
            model.position.y = -1.5; // Align feet
            playerGroup.add(model);
        }, undefined, () => {
            // Fallback Noob
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), new THREE.MeshStandardMaterial({color:'yellow'}));
            playerGroup.add(mesh);
        });

        // CONTROLS
        const controls = new PointerLockControls(cameraPivot, document.body);
        const keys = { w:0, a:0, s:0, d:0 };
        const velocity = new THREE.Vector3();
        
        document.addEventListener('click', () => {
            if(document.getElementById('chat-input').style.display === 'none') controls.lock();
        });

        // CHAT LOGIC
        const chatInput = document.getElementById('chat-input');
        document.addEventListener('keydown', (e) => {
            if (e.key === '/' && controls.isLocked) {
                e.preventDefault(); // Don't type '/'
                controls.unlock();
                chatInput.style.display = 'block';
                chatInput.focus();
            }
            if (e.key === 'Enter' && document.activeElement === chatInput) {
                const text = chatInput.value;
                if(text) {
                    const line = document.createElement('div');
                    line.className = 'user-msg';
                    line.innerText = `${USERNAME}: ${text}`;
                    document.getElementById('chat-history').appendChild(line);
                    chatInput.value = '';
                }
                chatInput.style.display = 'none';
                controls.lock();
            }
            
            // Movement
            switch(e.code) {
                case 'KeyW': keys.w = 1; break;
                case 'KeyS': keys.s = 1; break;
                case 'KeyA': keys.a = 1; break;
                case 'KeyD': keys.d = 1; break;
                case 'Space': if(velocity.y === 0) velocity.y = 15; break;
            }
        });
        
        document.addEventListener('keyup', (e) => {
            switch(e.code) {
                case 'KeyW': keys.w = 0; break;
                case 'KeyS': keys.s = 0; break;
                case 'KeyA': keys.a = 0; break;
                case 'KeyD': keys.d = 0; break;
            }
        });

        // GAME LOOP
        const clock = new THREE.Clock();
        
        function checkCollision(newPos) {
            // Simple Point Collision for feet
            const playerBox = new THREE.Box3();
            // Create a virtual box for the player (size 1x2x1) at newPos
            playerBox.min.set(newPos.x - 0.5, newPos.y - 1.5, newPos.z - 0.5);
            playerBox.max.set(newPos.x + 0.5, newPos.y + 0.5, newPos.z + 0.5);

            for (const wall of worldColliders) {
                if (playerBox.intersectsBox(wall)) return true;
            }
            return false;
        }

        function animate() {
            requestAnimationFrame(animate);
            const dt = Math.min(clock.getDelta(), 0.1);

            if (controls.isLocked) {
                // 1. GRAVITY
                velocity.y -= 30 * dt;

                // 2. HORIZONTAL MOVEMENT
                const speed = 10;
                const direction = new THREE.Vector3();
                const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(cameraPivot.quaternion);
                forward.y = 0; forward.normalize();
                const right = new THREE.Vector3(1, 0, 0).applyQuaternion(cameraPivot.quaternion);
                right.y = 0; right.normalize();

                if (keys.w) direction.add(forward);
                if (keys.s) direction.sub(forward);
                if (keys.d) direction.add(right);
                if (keys.a) direction.sub(right);
                direction.normalize().multiplyScalar(speed * dt);

                // 3. APPLY & COLLIDE (Basic)
                const oldPos = playerGroup.position.clone();
                
                // X Check
                playerGroup.position.x += direction.x;
                if(checkCollision(playerGroup.position)) playerGroup.position.x = oldPos.x;

                // Z Check
                playerGroup.position.z += direction.z;
                if(checkCollision(playerGroup.position)) playerGroup.position.z = oldPos.z;

                // Y Check (Floor/Gravity)
                playerGroup.position.y += velocity.y * dt;
                if(checkCollision(playerGroup.position)) {
                    // Hit floor or ceiling
                    if(velocity.y < 0) { // Landing
                        velocity.y = 0;
                        // Snap to top of object (rough approximation for this demo)
                        playerGroup.position.y = Math.round(playerGroup.position.y * 2) / 2; 
                    } else {
                        playerGroup.position.y = oldPos.y; // Hit head
                        velocity.y = 0;
                    }
                }
                
                if(playerGroup.position.y < -10) {
                    playerGroup.position.set(0, 5, 0); // Void Reset
                    velocity.set(0,0,0);
                }
            }

            // CAMERA FOLLOW (3rd Person)
            // Camera is offset BEHIND the pivot
            const camOffset = new THREE.Vector3(0, 0.5, 6); // Distance: 6
            camOffset.applyQuaternion(cameraPivot.quaternion);
            const targetPos = cameraPivot.getWorldPosition(new THREE.Vector3());
            
            camera.position.lerp(targetPos.clone().add(camOffset), 0.2);
            camera.lookAt(targetPos);

            renderer.render(scene, camera);
        }
        
        animate();
    </script>
</body>
</html>
