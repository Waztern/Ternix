<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TerNix Player 2014</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; user-select: none; background: black; }
        
        /* --- 2014 IN-GAME GUI (CORE GUI) --- */
        #core-gui { position: absolute; inset: 0; pointer-events: none; }

        /* Игрок Справа Сверху */
        #player-list {
            position: absolute; top: 0; right: 20px; width: 160px;
            background: rgba(30, 30, 30, 0.7); 
            color: white; border-bottom-left-radius: 5px; border-bottom-right-radius: 5px;
        }
        .pl-header {
            background: #333; color: #eee; font-size: 12px; padding: 5px; font-weight: bold;
            border-bottom: 1px solid #555;
        }
        .pl-entry {
            padding: 4px 8px; font-size: 13px; display: flex; justify-content: space-between;
        }

        /* Чат Слева Сверху */
        #chat-container {
            position: absolute; top: 20px; left: 20px; width: 300px; height: 200px;
            display: flex; flex-direction: column; pointer-events: auto;
        }
        #chat-box {
            flex: 1; overflow-y: auto; 
            text-shadow: 1px 1px 0 #000; font-size: 14px; color: white; font-weight: bold;
        }
        #chat-input {
            background: rgba(0,0,0,0.5); border: 1px solid #aaa; color: white;
            display: none; /* Скрыт пока не нажмешь / */
        }

        /* Меню слева сверху (Гамбургер) */
        .menu-btn {
            position: absolute; top: -35px; left: 0; /* Скрыто для теста */
        }

        /* Инструкция в центре (исчезает) */
        #click-to-play {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 24px; text-align: center; background: rgba(0,0,0,0.5); padding: 20px;
            pointer-events: auto; cursor: pointer; border: 2px solid white;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <!-- GUI -->
    <div id="core-gui">
        <div id="player-list">
            <div class="pl-header">Leaderboard</div>
            <div class="pl-entry">
                <span id="my-name">Guest</span>
                <span>100</span>
            </div>
        </div>

        <div id="chat-container">
            <div id="chat-box">
                <div style="color:#ffff00;">System: Welcome to TerNix.</div>
            </div>
            <input type="text" id="chat-input" placeholder="Chat here...">
        </div>
    </div>

    <div id="click-to-play">
        CLICK TO PLAY<br>
        <span style="font-size:14px">(WASD to Move, Mouse to Look)</span>
    </div>

    <!-- 3D CANVAS -->
    <div id="game-world"></div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // 1. НАСТРОЙКА МИРА
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xb0d6f5); // Небо 2014
        scene.fog = new THREE.Fog(0xb0d6f5, 10, 100);

        const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Свет
        const sun = new THREE.DirectionalLight(0xffffff, 0.8);
        sun.position.set(50, 100, 50);
        sun.castShadow = true;
        scene.add(sun);
        const amb = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(amb);

        // 2. КАРТА (Crossroads Style)
        const matGray = new THREE.MeshLambertMaterial({color: 0x666666});
        const matGreen = new THREE.MeshLambertMaterial({color: 0x287f26});

        // Земля
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), matGreen);
        floor.rotation.x = -Math.PI/2;
        floor.receiveShadow = true;
        scene.add(floor);

        // Стена/Блок
        const wall = new THREE.Mesh(new THREE.BoxGeometry(10, 10, 10), matGray);
        wall.position.set(0, 5, -20);
        wall.castShadow = true;
        scene.add(wall);

        // 3. ИГРОК И УПРАВЛЕНИЕ
        let moveForward = false;
        let moveBackward = false;
        let moveLeft = false;
        let moveRight = false;
        let canJump = false;

        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();

        // Управление мышкой (PointerLock)
        const controls = new PointerLockControls(camera, document.body);
        
        const overlay = document.getElementById('click-to-play');
        
        overlay.addEventListener('click', () => {
            controls.lock(); // Блокируем курсор
        });

        controls.addEventListener('lock', () => {
            overlay.style.display = 'none';
        });

        controls.addEventListener('unlock', () => {
            overlay.style.display = 'block';
        });

        scene.add(controls.getObject());

        // Клавиатура
        const onKeyDown = function(event) {
            switch (event.code) {
                case 'ArrowUp':
                case 'KeyW': moveForward = true; break;
                case 'ArrowLeft':
                case 'KeyA': moveLeft = true; break;
                case 'ArrowDown':
                case 'KeyS': moveBackward = true; break;
                case 'ArrowRight':
                case 'KeyD': moveRight = true; break;
                case 'Space':
                    if (canJump === true) velocity.y += 25; // Прыжок
                    canJump = false;
                    break;
                case 'Slash': // Чат
                    if(controls.isLocked) {
                        controls.unlock();
                        setTimeout(() => document.getElementById('chat-input').style.display = 'block', 100);
                        document.getElementById('chat-input').focus();
                    }
                    break;
            }
        };

        const onKeyUp = function(event) {
            switch (event.code) {
                case 'ArrowUp':
                case 'KeyW': moveForward = false; break;
                case 'ArrowLeft':
                case 'KeyA': moveLeft = false; break;
                case 'ArrowDown':
                case 'KeyS': moveBackward = false; break;
                case 'ArrowRight':
                case 'KeyD': moveRight = false; break;
            }
        };

        document.addEventListener('keydown', onKeyDown);
        document.addEventListener('keyup', onKeyUp);

        // Чат Логика
        const chatInp = document.getElementById('chat-input');
        chatInp.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') {
                const msg = chatInp.value;
                if(msg) {
                    const div = document.createElement('div');
                    div.innerText = localStorage.getItem('ternix_user') + ": " + msg;
                    document.getElementById('chat-box').appendChild(div);
                }
                chatInp.value = '';
                chatInp.style.display = 'none';
                controls.lock(); // Возвращаем управление
            }
        });

        // Загрузка Персонажа (Или создание Нуба)
        let playerModel = null;
        const loader = new GLTFLoader();
        
        // Попытка загрузить файл
        loader.load('Ternix.Guy.glb', (gltf) => {
            playerModel = gltf.scene;
            playerModel.scale.set(0.5, 0.5, 0.5); // Уменьшаем модель
            scene.add(playerModel);
        }, undefined, (error) => {
            console.log("Модель не найдена, создаем куб.");
            // Нет модели - не страшно, камера сама по себе игрок
        });

        // 4. ГЛАВНЫЙ ЦИКЛ (PHYSICS)
        let prevTime = performance.now();

        function animate() {
            requestAnimationFrame(animate);

            const time = performance.now();
            const delta = (time - prevTime) / 1000;

            if (controls.isLocked === true) {
                // Торможение
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;
                velocity.y -= 9.8 * 10.0 * delta; // Гравитация (100.0 = масса)

                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize(); // чтобы по диагонали не бегал быстрее

                if (moveForward || moveBackward) velocity.z -= direction.z * 400.0 * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * 400.0 * delta;

                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);

                // Пол
                if (controls.getObject().position.y < 5) { // 5 = высота глаз
                    velocity.y = 0;
                    controls.getObject().position.y = 5;
                    canJump = true;
                }
                
                // Двигаем модель за камерой (если она есть)
                if(playerModel) {
                    playerModel.position.copy(controls.getObject().position);
                    playerModel.position.y -= 5; // Опускаем модель к ногам
                    // Поворот модели спиной к камере
                    playerModel.rotation.y = controls.getObject().rotation.y; 
                }
            }

            prevTime = time;
            renderer.render(scene, camera);
        }

        // Имя
        document.getElementById('my-name').innerText = localStorage.getItem('ternix_user') || "Guest";

        animate();
    </script>
</body>
</html>
