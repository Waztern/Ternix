<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TerNix 3D - Beta</title>
    <style>
        /* --- CORE UI STYLES --- */
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; }
        
        /* Game Layer */
        #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        /* UI Layer */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        /* Top Bar */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(20, 20, 20, 0.8); color: white;
            padding: 8px 20px; font-weight: bold; backdrop-filter: blur(4px);
            pointer-events: auto;
        }
        .currency { color: #ffda00; text-shadow: 0 0 5px rgba(255, 218, 0, 0.5); }

        /* Leaderboard */
        #leaderboard {
            position: absolute; top: 60px; right: 20px;
            width: 220px; background: rgba(0, 0, 0, 0.7);
            color: white; border-radius: 6px; overflow: hidden;
            pointer-events: auto;
        }
        .lb-head { background: rgba(255,255,255,0.1); padding: 8px 12px; font-size: 13px; font-weight: bold; display: flex; }
        .lb-row { padding: 6px 12px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; }
        .lb-name { flex: 1; }
        .lb-val { color: #ffda00; }

        /* Chat System */
        #chat-container {
            position: absolute; top: 60px; left: 20px;
            width: 300px; height: 250px;
            display: flex; flex-direction: column; justify-content: flex-end;
        }
        #chat-log {
            flex: 1; overflow-y: auto; 
            text-shadow: 1px 1px 2px black; color: white; font-size: 15px;
            scrollbar-width: none; /* Hide scrollbar */
        }
        #chat-input-box {
            margin-top: 10px; pointer-events: auto; opacity: 0; transition: 0.2s;
        }
        #chat-input {
            width: 100%; padding: 10px; border-radius: 4px; border: none;
            background: rgba(0,0,0,0.6); color: white; outline: 2px solid transparent;
        }
        #chat-input:focus { outline: 2px solid white; background: rgba(0,0,0,0.9); }

        /* Health Bar */
        #health-container {
            position: absolute; bottom: 20px; right: 20px;
            width: 200px; text-align: center;
        }
        .hp-text { color: white; font-size: 12px; font-weight: bold; margin-bottom: 4px; text-shadow: 1px 1px 1px black;}
        .hp-bg { width: 100%; height: 20px; background: #333; border: 2px solid white; border-radius: 4px; overflow: hidden; }
        .hp-fill { width: 100%; height: 100%; background: #00ff00; transition: width 0.2s; }

        /* Loading / Login Screen */
        #loading-screen {
            position: absolute; inset: 0; background: #222; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; pointer-events: auto;
        }
    </style>
    <!-- Import Three.js (The 3D Engine) -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <!-- 1. LOGIN SCREEN -->
    <div id="loading-screen">
        <h1 style="margin:0; font-size: 4em; color: #3498db;">TerNix</h1>
        <p style="opacity: 0.7;">Alpha Build 1.2 (GLB Support)</p>
        <br>
        <input type="text" id="username-input" placeholder="Username" value="Guest" style="padding: 10px 20px; font-size: 1.2em; text-align: center;">
        <br>
        <button id="play-btn" style="padding: 10px 40px; font-size: 1.5em; background: #27ae60; color: white; border: none; cursor: pointer;">PLAY</button>
    </div>

    <!-- 2. UI OVERLAY -->
    <div id="ui-layer">
        <div class="top-bar">
            <div>TerNix Alpha</div>
            <div class="currency">Fierens: 100</div>
        </div>

        <div id="leaderboard">
            <div class="lb-head"><div class="lb-name">Player</div><div>Fierens</div></div>
            <div id="lb-content"></div>
        </div>

        <div id="chat-container">
            <div id="chat-log">
                <div style="opacity: 0.7;"><i>System: Press '/' to chat.</i></div>
            </div>
            <div id="chat-input-box">
                <input type="text" id="chat-input" placeholder="Say something...">
            </div>
        </div>

        <div id="health-container">
            <div class="hp-text">HEALTH</div>
            <div class="hp-bg"><div class="hp-fill" id="hp-bar"></div></div>
        </div>
    </div>

    <!-- 3. 3D CANVAS -->
    <div id="game-container"></div>

    <!-- 4. GAME LOGIC -->
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- VARIABLES ---
        let camera, scene, renderer;
        let player, mixer; // Player mesh and animation mixer
        let keys = { w: false, a: false, s: false, d: false };
        let isChatting = false;
        let username = "Guest";
        const clock = new THREE.Clock();

        // --- INIT GAME ---
        document.getElementById('play-btn').addEventListener('click', () => {
            const input = document.getElementById('username-input').value;
            if(input.trim()) username = input;
            document.getElementById('loading-screen').style.display = 'none';
            init();
            updateLeaderboard();
            animate();
        });

        function init() {
            const container = document.getElementById('game-container');

            // 1. SCENE
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB); // Sky Blue
            scene.fog = new THREE.Fog(0x87CEEB, 10, 50); // Fog for depth

            // 2. CAMERA
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);

            // 3. RENDERER
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            // 4. LIGHTS
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.8);
            scene.add(hemiLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 1);
            dirLight.position.set(10, 20, 10);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // 5. FLOOR (The "Baseplate")
            const floorGeo = new THREE.PlaneGeometry(100, 100);
            const floorMat = new THREE.MeshStandardMaterial({ color: 0x448844 });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2; // Fix rotation (Make it flat)
            floor.receiveShadow = true;
            scene.add(floor);

            const gridHelper = new THREE.GridHelper(100, 100);
            scene.add(gridHelper);

            // 6. LOAD PLAYER (GLB)
            const loader = new GLTFLoader();
            loader.load('./Ternix.Guy.glb', 
                (gltf) => {
                    player = gltf.scene;
                    player.scale.set(1, 1, 1); // Adjust if your model is too big/small
                    player.position.set(0, 0, 0);
                    player.traverse(c => { if(c.isMesh) c.castShadow = true; });
                    scene.add(player);
                    console.log("Model Loaded Successfully");
                },
                undefined,
                (error) => {
                    console.error("Error loading GLB:", error);
                    // Fallback to Cube if model fails
                    const geo = new THREE.BoxGeometry(1, 2, 1);
                    const mat = new THREE.MeshStandardMaterial({ color: 'red' });
                    player = new THREE.Mesh(geo, mat);
                    player.position.y = 1;
                    scene.add(player);
                }
            );
        }

        // --- INPUT SYSTEM ---
        window.addEventListener('keydown', (e) => {
            if (e.key === '/') {
                e.preventDefault();
                toggleChat();
                return;
            }
            if (isChatting) return; // Stop moving if chatting

            switch(e.key.toLowerCase()) {
                case 'w': keys.w = true; break;
                case 's': keys.s = true; break;
                case 'a': keys.a = true; break;
                case 'd': keys.d = true; break;
            }
        });

        window.addEventListener('keyup', (e) => {
            switch(e.key.toLowerCase()) {
                case 'w': keys.w = false; break;
                case 's': keys.s = false; break;
                case 'a': keys.a = false; break;
                case 'd': keys.d = false; break;
            }
        });

        // --- CHAT LOGIC ---
        const chatInput = document.getElementById('chat-input');
        const chatBox = document.getElementById('chat-input-box');
        const chatLog = document.getElementById('chat-log');

        function toggleChat() {
            if (!isChatting) {
                // Open
                isChatting = true;
                chatBox.style.opacity = '1';
                chatInput.focus();
            } else {
                // Close
                isChatting = false;
                chatBox.style.opacity = '0';
                chatInput.blur();
            }
        }

        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && chatInput.value.trim() !== "") {
                addChatMessage(username, chatInput.value);
                chatInput.value = "";
                toggleChat(); // Close after sending
            }
        });

        function addChatMessage(name, msg) {
            const div = document.createElement('div');
            div.innerHTML = `<b>[${name}]:</b> ${msg}`;
            chatLog.appendChild(div);
            chatLog.scrollTop = chatLog.scrollHeight; // Auto scroll
        }

        // --- LEADERBOARD ---
        function updateLeaderboard() {
            const lb = document.getElementById('lb-content');
            const data = [
                { n: username, s: 100 },
                { n: "BuilderMan", s: 999 },
                { n: "Guest_99", s: 0 }
            ];
            lb.innerHTML = data.map(p => `
                <div class="lb-row">
                    <div class="lb-name">${p.n}</div>
                    <div class="lb-val">${p.s}</div>
                </div>
            `).join('');
        }

        // --- GAME LOOP ---
        function animate() {
            requestAnimationFrame(animate);

            const delta = clock.getDelta(); // Time between frames

            if (player && !isChatting) {
                const speed = 5 * delta;
                if (keys.w) player.position.z -= speed;
                if (keys.s) player.position.z += speed;
                if (keys.a) player.position.x -= speed;
                if (keys.d) player.position.x += speed;

                // Simple Camera Follow
                camera.position.x = player.position.x;
                camera.position.z = player.position.z + 8; // Distance behind
                camera.position.y = player.position.y + 5; // Height
                camera.lookAt(player.position);
            }

            renderer.render(scene, camera);
        }

        // Resize handler
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
