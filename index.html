<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>TerNix 3D - Final Alpha</title>
    <!-- Пытаемся загрузить движок через надежный шлюз -->
    <script async src="https://ga.jspm.io"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com",
            "three/examples/jsm/loaders/GLTFLoader": "https://unpkg.com"
        }
    }
    </script>
    <style>
        body { margin: 0; overflow: hidden; background: #0055ff; font-family: "Arial", sans-serif; }
        #login { position: fixed; inset: 0; background: #0055ff; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        #login input { padding: 15px; width: 280px; border: none; font-size: 20px; text-align: center; margin-bottom: 20px; border-radius: 5px; }
        #play-btn { padding: 15px 100px; background: #00aa00; color: white; border: none; font-weight: bold; cursor: pointer; font-size: 20px; border-radius: 5px; }
        #play-btn:disabled { background: #555; cursor: wait; }
        
        header { position: absolute; top: 0; width: 100%; height: 45px; background: #0044ee; color: white; display: flex; align-items: center; padding: 0 20px; z-index: 500; border-bottom: 2px solid #002288; box-sizing: border-box; }
        #chat-bar { position: absolute; bottom: 0; width: 100%; background: #fff; border-top: 3px solid #333; padding: 15px; z-index: 600; box-sizing: border-box; }
        #chat-input { width: 100%; border: none; outline: none; font-size: 18px; }
        #hp-ui { position: absolute; top: 60px; right: 20px; background: rgba(0,0,0,0.6); padding: 10px; border: 2px solid #fff; z-index: 400; width: 180px; }
        #hp-fill { width: 100%; height: 18px; background: red; transition: 0.3s; }
        #chat-log { position: absolute; top: 60px; left: 20px; color: white; text-shadow: 2px 2px #000; z-index: 400; pointer-events: none; }
    </style>
</head>
<body>

<div id="login">
    <h1 style="font-size: 60px;">TerNix</h1>
    <input type="text" id="nick" placeholder="@username">
    <button id="play-btn" disabled>LOADING ENGINE...</button>
</div>

<header><b>TerNix 3D Alpha</b> <div style="margin-left:auto">Hex: 100</div></header>
<div id="chat-log"></div>
<div id="hp-ui">
    <div style="color:white; font-size:12px; font-weight:bold;">HEALTH</div>
    <div style="background:#333;"><div id="hp-fill"></div></div>
</div>

<div id="chat-bar"><input type="text" id="chat-input" placeholder='Нажми "/" для чата...'></div>

<script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader';

    let scene, camera, renderer, player, username = "@Guest", hp = 100;
    let keys = {}, velY = 0, jumping = false;
    const btn = document.getElementById('play-btn');

    // Кнопка станет активной, когда THREE подгрузится
    btn.disabled = false;
    btn.innerText = "PLAY";
    btn.onclick = play;

    function play() {
        let n = document.getElementById('nick').value;
        if(n) username = n.startsWith('@') ? n : '@'+n;
        document.getElementById('login').style.display = 'none';
        init();
    }

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.9));
        scene.add(new THREE.GridHelper(100, 50));

        // Красный блок урона
        const lava = new THREE.Mesh(new THREE.BoxGeometry(6, 0.2, 6), new THREE.MeshPhongMaterial({color: 0xff0000}));
        lava.position.set(15, 0, -15);
        scene.add(lava);

        // Загрузка модели
        const loader = new GLTFLoader();
        loader.load('Ternix.Guy.glb', (gltf) => {
            player = gltf.scene;
            scene.add(player);
        }, undefined, () => {
            // Если модель не найдена - создаем нормального челика (тело, голова, руки)
            player = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(1, 1.4, 0.6), new THREE.MeshPhongMaterial({color: 0x888888}));
            player.add(body);
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.7, 0.7, 0.7), new THREE.MeshPhongMaterial({color: 0xffdbac}));
            head.position.y = 1.1;
            player.add(head);
            scene.add(player);
        });

        camera.position.set(0, 7, 12);

        window.onkeydown = (e) => {
            if(e.key === '/') { e.preventDefault(); document.getElementById('chat-input').focus(); }
            if(e.code === 'Space' && !jumping) { velY = 0.25; jumping = true; }
            keys[e.code] = true;
        };
        window.onkeyup = (e) => keys[e.code] = false;

        animate();
    }

    function animate() {
        requestAnimationFrame(animate);
        if(player && document.activeElement.id !== 'chat-input') {
            if(keys['KeyW']) player.translateZ(-0.2);
            if(keys['KeyS']) player.translateZ(0.2);
            if(keys['KeyA']) player.rotation.y += 0.06;
            if(keys['KeyD']) player.rotation.y -= 0.06;

            player.position.y += velY;
            if(player.position.y > 0) velY -= 0.012;
            else { player.position.y = 0; velY = 0; jumping = false; }

            if(Math.abs(player.position.x - 15) < 3 && Math.abs(player.position.z + 15) < 3) {
                hp -= 0.5; if(hp < 0) hp = 0;
                document.getElementById('hp-fill').style.width = hp + "%";
            }

            camera.position.lerp(player.position.clone().add(new THREE.Vector3(0, 7, 12).applyQuaternion(player.quaternion)), 0.1);
            camera.lookAt(player.position);
        }
        renderer.render(scene, camera);
    }

    document.getElementById('chat-input').onkeypress = (e) => {
        if(e.key === 'Enter' && e.target.value !== "") {
            document.getElementById('chat-log').innerHTML += `<div><b>${username}:</b> ${e.target.value}</div>`;
            e.target.value = ""; e.target.blur();
        }
    };
</script>
</body>
</html>
