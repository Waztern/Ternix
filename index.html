<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TerNix - 2010 Legacy</title>
    <style>
        /* --- TERNIX 2010 THEME --- */
        body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; background: #202020; user-select: none; }
        
        /* Убираем закругления везде */
        * { border-radius: 0 !important; box-sizing: border-box; }

        /* --- ЭКРАН ВХОДА (LOGIN) --- */
        #login-screen {
            position: absolute; inset: 0; background: #dcdcdc; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 5px solid #0055b3;
        }
        .login-box {
            width: 400px; background: white; border: 1px solid #777; padding: 20px;
            box-shadow: 5px 5px 0px rgba(0,0,0,0.2); text-align: center;
        }
        .legacy-btn {
            background: linear-gradient(#00a2ff, #0055b3); border: 1px solid #003366;
            color: white; font-weight: bold; padding: 8px 20px; cursor: pointer; font-size: 16px; margin-top: 10px;
        }
        .legacy-btn:hover { background: linear-gradient(#22b4ff, #0066cc); }
        .legacy-input {
            width: 100%; padding: 5px; border: 1px solid #999; font-size: 14px; margin-bottom: 10px;
        }

        /* --- ИГРОВОЙ ИНТЕРФЕЙС (HUD) --- */
        #game-ui { display: none; position: absolute; inset: 0; pointer-events: none; z-index: 10; }

        /* Верхняя панель */
        .top-bar {
            height: 30px; background: #0055b3; border-bottom: 2px solid white;
            display: flex; align-items: center; padding: 0 10px; color: white; font-weight: bold; font-size: 14px;
            pointer-events: auto;
        }
        .currency { margin-left: 20px; color: #ffcc00; }
        
        /* Таблица игроков */
        #leaderboard {
            position: absolute; top: 40px; right: 10px; width: 180px;
            background: rgba(0,0,0,0.5); border: 1px solid #555; color: white;
            pointer-events: auto;
        }
        .lb-header { background: #333; padding: 5px; font-weight: bold; font-size: 12px; }
        .lb-row { padding: 4px; font-size: 12px; border-bottom: 1px solid #444; display: flex; justify-content: space-between; }

        /* Чат (Legacy Style) */
        #chat-wrapper {
            position: absolute; top: 40px; left: 10px; width: 300px; height: 200px;
            pointer-events: auto; display: flex; flex-direction: column;
        }
        #chat-log {
            flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #777; overflow-y: auto;
            color: white; text-shadow: 1px 1px 0 #000; padding: 5px; font-size: 14px; font-family: 'Verdana', sans-serif;
        }
        #chat-input {
            width: 100%; height: 25px; border: 1px solid #fff; background: rgba(0,0,0,0.5); color: white; margin-top: 5px;
        }

        /* Сообщения */
        #msg-area { position: absolute; top: 50%; width: 100%; text-align: center; color: red; font-weight: bold; font-size: 24px; text-shadow: 2px 2px 0 black; }
    </style>
    <!-- Three.js Core -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <!-- 1. LOGIN SCREEN -->
    <div id="login-screen">
        <h1 style="color: #0055b3; margin: 0 0 20px 0; font-size: 40px;">TerNix</h1>
        <div class="login-box">
            <h3 style="margin-top:0">Member Login</h3>
            <input type="text" id="username" class="legacy-input" placeholder="Username" value="Guest">
            <input type="password" class="legacy-input" placeholder="Password" disabled style="background:#eee;">
            <button class="legacy-btn" onclick="startGame()">Play Now</button>
        </div>
        <p style="color:#555; font-size: 12px; margin-top: 10px;">TerNix 2014 Engine - No Plugins Required</p>
    </div>

    <!-- 2. GAME HUD -->
    <div id="game-ui">
        <div class="top-bar">
            <span>TerNix Alpha</span>
            <span class="currency">Fierens: 100</span>
            <span class="currency" style="color:#00aaff;">Nex: 50</span>
            <button onclick="resetPlayer()" style="margin-left:auto; font-size:10px; cursor:pointer;">RESET CHAR</button>
        </div>

        <div id="leaderboard">
            <div class="lb-header">Players</div>
            <div id="lb-content"></div>
        </div>

        <div id="chat-wrapper">
            <div id="chat-log">
                <div style="color:#aaa;">System: Welcome to TerNix.</div>
            </div>
            <input type="text" id="chat-input" placeholder="Press '/' to chat...">
        </div>
        
        <div id="msg-area"></div>
    </div>

    <!-- 3D CONTAINER -->
    <div id="world"></div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- CONFIG ---
        let scene, camera, renderer, player, controls;
        let keys = { w:0, a:0, s:0, d:0 };
        let velocity = new THREE.Vector3();
        let onGround = false;
        let isChatting = false;
        let myName = "Guest";
        let platforms = []; // Для паркура

        window.startGame = function() {
            const input = document.getElementById('username').value;
            if(input) myName = input;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            init();
            updateLeaderboard();
            animate();
        };

        window.resetPlayer = function() {
            if(player) {
                player.position.set(0, 5, 0);
                velocity.set(0,0,0);
            }
        }

        function updateLeaderboard() {
            document.getElementById('lb-content').innerHTML = `
                <div class="lb-row"><span>${myName}</span><span>100</span></div>
            `;
        }

        function init() {
            // 1. SCENE
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xb0d6f5); // Classic Sky
            scene.fog = new THREE.Fog(0xb0d6f5, 20, 120);

            // 2. CAMERA
            camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 10, -15);

            // 3. RENDERER
            renderer = new THREE.WebGLRenderer({ antialias: false }); // False for retro feel
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('world').appendChild(renderer.domElement);

            // 4. LIGHTS
            const amb = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(amb);
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(20, 50, 20);
            sun.castShadow = true;
            scene.add(sun);

            // 5. MAP GENERATION (PARKOUR)
            createPlatform(0, 0, 0, 20, 20, 0x228822); // Spawn
            createPlatform(0, 2, 18, 6, 6, 0x555555);  // Jump 1
            createPlatform(0, 4, 30, 4, 4, 0x555555);  // Jump 2
            createPlatform(5, 6, 40, 4, 4, 0x555555);  // Jump 3
            createPlatform(-5, 8, 50, 4, 4, 0x555555); // Jump 4
            createPlatform(0, 10, 65, 15, 15, 0xffda00); // Gold Finish

            // Lava Floor
            const lava = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshBasicMaterial({color:0xff0000}));
            lava.rotation.x = -Math.PI/2;
            lava.position.y = -10;
            scene.add(lava);

            // 6. PLAYER (Try GLB -> Fail -> Make Noob)
            loadPlayer();

            // 7. CONTROLS
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enablePan = false;
            controls.minDistance = 5;
            controls.maxDistance = 25;
            controls.mouseButtons = { LEFT: null, MIDDLE: null, RIGHT: THREE.MOUSE.ROTATE };

            // Events
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
        }

        function createPlatform(x, y, z, w, d, color) {
            const geo = new THREE.BoxGeometry(w, 1, d);
            const mat = new THREE.MeshLambertMaterial({ color: color });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(x, y, z);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            scene.add(mesh);
            
            // Добавляем в массив для физики
            platforms.push(new THREE.Box3().setFromObject(mesh));
        }

        function loadPlayer() {
            const loader = new GLTFLoader();
            // Пытаемся загрузить твой файл
            loader.load('./Ternix.Guy.glb', 
                (gltf) => {
                    player = gltf.scene;
                    scene.add(player);
                },
                undefined,
                (err) => {
                    console.log("Модель сломана, создаем Нуба.");
                    createNoob(); // Если ошибка - делаем робота
                }
            );
        }

        function createNoob() {
            player = new THREE.Group();
            
            const matY = new THREE.MeshStandardMaterial({color:0xffff00}); // Желтый
            const matB = new THREE.MeshStandardMaterial({color:0x0000ff}); // Синий
            const matG = new THREE.MeshStandardMaterial({color:0x00aa00}); // Зеленый

            // Torso
            const torso = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 1), matB);
            torso.position.y = 2;
            player.add(torso);

            // Head
            const head = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.2, 1.2), matY);
            head.position.y = 3.6;
            player.add(head);

            // Legs
            const lleg = new THREE.Mesh(new THREE.BoxGeometry(0.9, 2, 1), matG);
            lleg.position.set(-0.5, 1, 0);
            player.add(lleg);
            const rleg = new THREE.Mesh(new THREE.BoxGeometry(0.9, 2, 1), matG);
            rleg.position.set(0.5, 1, 0);
            player.add(rleg);

            scene.add(player);
            document.getElementById('msg-area').innerText = "";
        }

        // --- INPUT ---
        const chatIn = document.getElementById('chat-input');
        
        function onKeyDown(e) {
            if(e.key === '/' && !isChatting) {
                e.preventDefault();
                isChatting = true;
                chatIn.focus();
                keys.w=keys.a=keys.s=keys.d=0;
                return;
            }
            if(isChatting) return;

            switch(e.code) {
                case 'KeyW': keys.w = 1; break;
                case 'KeyS': keys.s = 1; break;
                case 'KeyA': keys.a = 1; break;
                case 'KeyD': keys.d = 1; break;
                case 'Space': if(onGround) { velocity.y = 0.6; onGround=false; } break;
            }
        }

        function onKeyUp(e) {
            switch(e.code) {
                case 'KeyW': keys.w = 0; break;
                case 'KeyS': keys.s = 0; break;
                case 'KeyA': keys.a = 0; break;
                case 'KeyD': keys.d = 0; break;
            }
        }

        chatIn.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') {
                if(chatIn.value) {
                    const log = document.getElementById('chat-log');
                    const d = document.createElement('div');
                    d.innerHTML = `<b>[${myName}]:</b> ${chatIn.value}`;
                    log.appendChild(d);
                    log.scrollTop = log.scrollHeight;
                }
                chatIn.value = ""; chatIn.blur(); isChatting = false;
            }
        });

        // --- PHYSICS LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            if(!player) return;

            // Cam Follow
            controls.target.copy(player.position);
            controls.update();

            // Move
            if(!isChatting) {
                const camDir = new THREE.Vector3();
                camera.getWorldDirection(camDir);
                camDir.y = 0; camDir.normalize();
                const camSide = new THREE.Vector3().crossVectors(camera.up, camDir).normalize();

                if(keys.w) player.position.addScaledVector(camDir, 0.2);
                if(keys.s) player.position.addScaledVector(camDir, -0.2);
                if(keys.a) player.position.addScaledVector(camSide, 0.2);
                if(keys.d) player.position.addScaledVector(camSide, -0.2);
                
                // Rotate
                if(keys.w || keys.s || keys.a || keys.d) {
                     const moveDir = new THREE.Vector3();
                     if(keys.w) moveDir.add(camDir);
                     if(keys.s) moveDir.sub(camDir);
                     if(keys.a) moveDir.add(camSide);
                     if(keys.d) moveDir.sub(camSide);
                     if(moveDir.lengthSq() > 0) player.rotation.y = Math.atan2(moveDir.x, moveDir.z);
                }
            }

            // Gravity & Collision
            velocity.y -= 0.02;
            player.position.y += velocity.y;

            // Simple Floor Check (Hardcoded 0 for spawn)
            if(player.position.y < 0 && player.position.y > -5) {
                // Check Platforms? Too complex for now, just infinite fall reset
            }
            
            // Platform Collision (Simple)
            onGround = false;
            // Check Spawn
            if(player.position.y <= 0 && player.position.x > -10 && player.position.x < 10 && player.position.z > -10 && player.position.z < 10) {
                player.position.y = 0; velocity.y = 0; onGround = true;
            }
            // Check Parkour Blocks
            platforms.forEach(box => {
                if(box.containsPoint(player.position)) {
                     // Very basic snap
                     if(player.position.y > box.max.y - 1) {
                         player.position.y = box.max.y;
                         velocity.y = 0;
                         onGround = true;
                     }
                }
            });

            // Lava Death
            if(player.position.y < -20) {
                resetPlayer();
            }

            renderer.render(scene, camera);
        }

        window.onresize = () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
